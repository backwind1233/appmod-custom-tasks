name: PR Validation

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

jobs:
  validate-tasks:
    name: Validate Task Format
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for comparing changes

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: scripts/package.json

      - name: Install dependencies
        run: |
          cd scripts
          npm install

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            tasks/**/task.md
            tasks/**/*.java
            tasks/**/*.py
            tasks/**/*.xml
            tasks/**/*.json
            tasks/**/*.properties
            tasks/**/*.yml
            tasks/**/*.yaml
          files_ignore: |
            scripts/**
            .github/**
            metadata.json
            README.md

      - name: Get changed task folders
        id: changed-tasks
        run: |
          CHANGED_FOLDERS=""
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            FOLDER=$(echo "$file" | cut -d'/' -f1)
            # Skip if folder starts with dot or is a known non-task folder
            if [[ ! "$FOLDER" =~ ^\..*$ ]] && \
               [[ "$FOLDER" != "scripts" ]] && \
               [[ "$FOLDER" != "templates" ]] && \
               [[ "$FOLDER" != "node_modules" ]] && \
               [[ -d "$FOLDER" ]]; then
              if [[ -f "$FOLDER/task.md" ]]; then
                CHANGED_FOLDERS="$CHANGED_FOLDERS $FOLDER"
              fi
            fi
          done
          # Remove duplicates and trim
          CHANGED_FOLDERS=$(echo "$CHANGED_FOLDERS" | tr ' ' '\n' | sort -u | tr '\n' ' ' | xargs)
          echo "folders=$CHANGED_FOLDERS" >> $GITHUB_OUTPUT
          echo "Changed task folders: $CHANGED_FOLDERS"

      - name: Validate task format
        if: steps.changed-tasks.outputs.folders != ''
        id: validate
        run: |
          cd scripts
          node validate-task.js .. ${{ steps.changed-tasks.outputs.folders }} > validation-report.md 2>&1 || true
          cat validation-report.md
          
          # Check if validation passed
          if grep -q "‚ùå Invalid tasks:" validation-report.md; then
            INVALID_COUNT=$(grep "‚ùå Invalid tasks:" validation-report.md | grep -oP '\d+')
            if [[ "$INVALID_COUNT" -gt 0 ]]; then
              echo "validation_passed=false" >> $GITHUB_OUTPUT
            else
              echo "validation_passed=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "validation_passed=true" >> $GITHUB_OUTPUT
          fi

      - name: Comment PR with validation results
        if: steps.changed-tasks.outputs.folders != '' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('scripts/validation-report.md', 'utf8');
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Task Validation Report')
            );
            
            const body = `## üîç Task Validation Report\n\n${report}`;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Fail if validation errors
        if: steps.validate.outputs.validation_passed == 'false'
        run: |
          echo "‚ùå Task validation failed. Please fix the errors above."
          exit 1

  check-metadata:
    name: Check Metadata Regeneration
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: scripts/package.json

      - name: Install dependencies
        run: |
          cd scripts
          npm install

      - name: Generate metadata and check for differences
        id: metadata-check
        run: |
          # Save current metadata
          cp metadata.json metadata.json.original
          
          # Regenerate metadata
          cd scripts
          npm start
          cd ..
          
          # Compare
          if ! diff -q metadata.json metadata.json.original > /dev/null 2>&1; then
            echo "metadata_outdated=true" >> $GITHUB_OUTPUT
            
            # Save the expected content for the PR comment
            cat metadata.json > metadata.json.expected
            
            echo "‚ö†Ô∏è metadata.json is out of date"
          else
            echo "metadata_outdated=false" >> $GITHUB_OUTPUT
            echo "‚úÖ metadata.json is up to date"
          fi

      - name: Comment PR with metadata diff
        if: steps.metadata-check.outputs.metadata_outdated == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const originalContent = fs.readFileSync('metadata.json.original', 'utf8');
            const expectedContent = fs.readFileSync('metadata.json.expected', 'utf8');
            
            // Create diff display
            const { execSync } = require('child_process');
            let diff = '';
            try {
              diff = execSync('diff -u metadata.json.original metadata.json.expected || true', { encoding: 'utf8' });
            } catch (e) {
              diff = e.stdout || 'Unable to generate diff';
            }
            
            const body = `## ‚ö†Ô∏è metadata.json needs to be updated
            
            The \`metadata.json\` file is out of sync with the current task definitions.
            
            <details>
            <summary>üìã Click to view the diff</summary>
            
            \`\`\`diff
            ${diff}
            \`\`\`
            
            </details>
            
            <details>
            <summary>üìÑ Click to view the complete updated metadata.json</summary>
            
            \`\`\`json
            ${expectedContent}
            \`\`\`
            
            </details>
            
            ### How to apply this change:
            
            1. Click **"üìÑ Click to view the complete updated metadata.json"** above
            2. Copy the JSON content
            3. In the **Files changed** tab, click the **‚ãØ** menu on \`metadata.json\` ‚Üí **Edit file**
            4. Replace the content and commit
            
            Or run locally: \`cd scripts && npm start\`
            `;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('metadata.json needs to be updated')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Fail if metadata outdated
        if: steps.metadata-check.outputs.metadata_outdated == 'true'
        run: |
          echo "‚ùå metadata.json is out of date. Please review the PR comment and apply the changes."
          exit 1
